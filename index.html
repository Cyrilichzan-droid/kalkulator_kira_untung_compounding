<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Keuntungan Tahunan</title>
    <!-- Link to the Web App Manifest for PWA features -->
    <link rel="manifest" href="manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/aspect-ratio@0.4.2/dist/aspect-ratio.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Configure Tailwind for Inter font and define custom loss color -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#059669', // Emerald 600 (Green - Profit)
                        'secondary': '#facc15', // Amber 400
                        'loss': '#dc2626', // Red 600 (New color for loss)
                        'background': '#f3f4f6', // Gray 100
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom styles for the main card */
        .card {
            /* Standard shadow */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease;
        }

        /* Dynamic Glow Effect for the main card */
        .card-profit-glow:hover { 
            transform: translateY(-2px);
            /* Brighter green glow (primary color) */
            box-shadow: 0 0 40px rgba(5, 150, 105, 0.4), 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        }

        /* Red Glow for Loss Card */
        .card-loss-glow:hover {
            transform: translateY(-2px);
            /* Brighter red glow (loss color) */
            box-shadow: 0 0 40px rgba(220, 38, 38, 0.4), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Base style for result boxes */
        .result-box {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); 
        }

        /* Green Glow for Profit Result Box */
        .result-box-profit:hover {
            box-shadow: 0 0 15px rgba(5, 150, 105, 0.6); 
        }
        
        /* Red Glow for Loss Result Box */
        .result-box-loss:hover {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.6); /* Using loss color #dc2626 */
        }

        /* Hide default number input controls */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Custom styles for the language toggle switch */
        #lang-switch:checked + label #slider {
            transform: translateX(100%);
        }

        /* Styling for the Basic Calculator Modal */
        #basicCalculatorWrapper.active {
            opacity: 1;
            pointer-events: auto; /* Re-enable interactions */
        }
        #basicCalculatorWrapper {
            opacity: 0;
            pointer-events: none; /* Block interactions when hidden */
            transition: opacity 0.3s ease;
        }
        .calc-btn {
            @apply rounded-xl font-bold text-2xl py-3 shadow-md transition transform duration-150;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <!-- Basic Calculator Component (Modal Overlay) -->
    <!-- Default hidden using Tailwind's 'hidden' class, managed by JS for smooth transition -->
    <div id="basicCalculatorWrapper" class="fixed inset-0 bg-black bg-opacity-50 hidden flex z-50 items-center justify-center">
        <!-- The calculator card itself is centered in the fixed container -->
        <div id="basicCalculator" class="bg-gray-800 p-4 rounded-3xl shadow-2xl w-full max-w-xs transition-transform duration-300 relative">
            
            <!-- Close Button -->
            <button onclick="toggleBasicCalculator()" class="absolute -top-3 -right-3 bg-red-600 text-white rounded-full h-8 w-8 flex items-center justify-center text-sm font-bold z-10 hover:bg-red-700 transition transform hover:scale-105" title="Tutup Kalkulator">
                X
            </button>

            <!-- Display -->
            <input type="text" id="calcDisplay" value="0" disabled class="w-full h-16 mb-4 text-4xl text-white bg-gray-900 rounded-2xl text-right p-3 font-mono border-2 border-gray-700">
            
            <!-- Buttons Grid -->
            <div class="grid grid-cols-4 gap-3">
                
                <!-- Row 1 -->
                <button onclick="calcClear()" class="calc-btn bg-gray-600 text-white col-span-2 hover:bg-gray-700">C</button>
                <button onclick="calcInput('/')" class="calc-btn bg-secondary text-gray-900 hover:bg-secondary/80">/</button>
                <button onclick="calcInput('*')" class="calc-btn bg-secondary text-gray-900 hover:bg-secondary/80">x</button>
                
                <!-- Row 2 -->
                <button onclick="calcInput('7')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">7</button>
                <button onclick="calcInput('8')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">8</button>
                <button onclick="calcInput('9')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">9</button>
                <button onclick="calcInput('-')" class="calc-btn bg-secondary text-gray-900 hover:bg-secondary/80">-</button>
                
                <!-- Row 3 -->
                <button onclick="calcInput('4')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">4</button>
                <button onclick="calcInput('5')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">5</button>
                <button onclick="calcInput('6')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">6</button>
                <button onclick="calcInput('+')" class="calc-btn bg-secondary text-gray-900 hover:bg-secondary/80">+</button>
                
                <!-- Row 4 -->
                <button onclick="calcInput('1')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">1</button>
                <button onclick="calcInput('2')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">2</button>
                <button onclick="calcInput('3')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">3</button>
                <button onclick="calcEquals()" class="calc-btn bg-primary text-white row-span-2 hover:bg-primary/90">=</button>
                
                <!-- Row 5 -->
                <button onclick="calcInput('0')" class="calc-btn bg-gray-700 text-white col-span-2 hover:bg-gray-600">0</button>
                <button onclick="calcInput('.')" class="calc-btn bg-gray-700 text-white hover:bg-gray-600">.</button>
            </div>
            
            <!-- Copy to Input feature -->
            <div class="mt-4 border-t border-gray-700 pt-3">
                <select id="copyTargetSelect" class="w-full bg-gray-700 text-white py-2 px-3 rounded-lg text-sm mb-2">
                    <option value="principal" id="copyToPrincipalOption">Salin ke Modal Awal</option>
                    <option value="rate" id="copyToRateOption">Salin ke Peratus Keuntungan</option>
                    <option value="fixedAmount" id="copyToFixedOption">Salin ke Jumlah Tetap</option>
                    <option value="durationValue" id="copyToDurationOption">Salin ke Tempoh (Nilai)</option>
                </select>
                <button onclick="copyBasicCalcResult()" class="w-full bg-primary text-white py-2 rounded-lg text-sm font-semibold hover:bg-primary/90 transition" id="copyToInputBtn">
                    Salin & Tutup
                </button>
            </div>
        </div>
    </div>
    
    <!-- Container is fluid on mobile and centered/max-width on desktop -->
    <div class="w-full max-w-4xl space-y-8">
        
        <!-- Language Toggle Switch (Positioned above the main header, aligned right) -->
        <div class="flex justify-end mb-4">
            <div class="w-24 h-8 relative">
                <input type="checkbox" id="lang-switch" class="hidden" onchange="toggleLanguage()">
                <label for="lang-switch" class="relative block w-full h-full bg-primary rounded-full cursor-pointer transition duration-300">
                    <!-- Sliding Indicator -->
                    <div id="slider" class="absolute top-0 left-0 w-1/2 h-full bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out"></div>
                    <!-- Text Labels -->
                    <div class="absolute inset-0 flex items-center justify-start text-xs font-bold pointer-events-none">
                        <span id="label-ms" class="w-1/2 text-center z-10 transition duration-150">MS</span>
                        <span id="label-en" class="w-1/2 text-center z-10 transition duration-150">EN</span>
                    </div>
                </label>
            </div>
        </div>

        <header class="text-center relative">
            <h1 class="text-2xl sm:text-4xl font-extrabold text-primary mb-2" id="headerTitle">Kalkulator Keuntungan Fleksibel</h1>
            <p class="text-gray-600 text-base sm:text-lg" id="headerSubtitle">Kira pulangan berdasarkan kadar yang fleksibel untuk tempoh masa yang anda pilih.</p>
        </header>

        <main class="flex justify-center">
            <!-- Combined Calculator Card: Max width set to lg (56rem) to keep it compact on desktop -->
            <div id="annual-profit-calculator" class="card bg-white p-6 sm:p-8 rounded-xl border-t-8 border-primary card-profit-glow w-full max-w-lg relative">
                
                <!-- Card Header with Toggle Button -->
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl sm:text-3xl font-bold text-primary" id="cardTitle">
                        Pengiraan Keuntungan
                    </h2>
                    <!-- Basic Calculator Toggle Button - Title attribute is set dynamically by JS -->
                    <button onclick="toggleBasicCalculator()" class="text-primary hover:text-green-700 transition-colors p-2 rounded-full transform hover:scale-105" id="toggleCalcBtn" title="">
                        <!-- SVG for Calculator Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="8" y1="6" x2="16" y2="6"/>
                            <line x1="8" y1="10" x2="16" y2="10"/>
                            <line x1="8" y1="14" x2="16" y2="14"/>
                            <line x1="12" y1="18" x2="12" y2="18"/>
                        </svg>
                    </button>
                </div>

                <!-- Exchange Rate Input -->
                <div class="mb-6 p-4 bg-secondary/10 rounded-lg border border-secondary/20">
                    <label for="exchangeRateInput" class="block text-sm font-medium text-gray-700" id="labelExchangeRateTitle">Kadar Tukaran (1 RM = USD)</label>
                    <div class="mt-1 flex space-x-2 items-center">
                        <span class="text-lg font-semibold text-gray-600">1 RM =</span>
                        <div class="relative flex items-center">
                            <input type="number" id="exchangeRateInput" value="0.2134" min="0.0001" step="0.0001" class="block w-24 rounded-md border-gray-300 shadow-sm p-3 border focus:border-secondary focus:ring-secondary text-right pr-3">
                        </div>
                        <span class="text-lg font-semibold text-gray-600">USD</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" id="labelExchangeRateSubtitle">Kadar ini ditetapkan secara manually.</p>
                </div>
                
                <div class="space-y-6">
                    <!-- Input 1: Modal Awal (with Currency Dropdown) -->
                    <div>
                        <label for="principal" class="block text-sm font-medium text-gray-700" id="labelPrincipal">Modal Awal</label>
                        <div class="flex space-x-2 mt-1">
                            <!-- Input and Select are given proportionate widths -->
                            <input type="number" id="principal" value="1000" min="0" step="100" class="block w-2/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                            <select id="principalCurrencySelect" onchange="convertPrincipalValue()" class="block w-1/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                <option value="MYR">RM</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Pilihan Jenis Keuntungan -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="labelCalcType">Pilih Cara Kira Keuntungan</label>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-6 bg-gray-50 p-3 rounded-lg">
                            <!-- Radio 1: Percentage -->
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="profitType" value="percentage" checked onclick="toggleCalculationType()" class="form-radio text-primary h-4 w-4 border-gray-300 focus:ring-primary">
                                <span class="ml-2 text-gray-700 font-medium" id="radioPercentage">Peratusan (%)</span>
                            </label>
                            <!-- Radio 2: Fixed Amount -->
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="profitType" value="fixed" onclick="toggleCalculationType()" class="form-radio text-primary h-4 w-4 border-gray-300 focus:ring-primary">
                                <span class="ml-2 text-gray-700 font-medium" id="radioFixed">Jumlah Tetap</span>
                            </label>
                        </div>
                    </div>

                    <!-- Input Group 2: Percentage (Compounding) -->
                    <div id="percentageInputGroup">
                        <label class="block text-sm font-medium text-gray-700" id="labelRate">Peratus Keuntungan (%)</label>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-1">
                            <!-- Stacks on mobile, in a row on sm+ -->
                            <div class="flex-grow">
                                <label for="rate" class="sr-only">Peratus</label>
                                <input type="number" id="rate" value="7" min="-100" max="100" step="0.1" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()" placeholder="Peratus">
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="rateFrequency" class="sr-only">Kekerapan</label>
                                <select id="rateFrequency" onchange="calculate()" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="day" id="rateFreqDay">Sehari</option>
                                    <option value="week" selected id="rateFreqWeek">Seminggu</option>
                                    <option value="month" id="rateFreqMonth">Sebulan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Input Group 3: Fixed Amount -->
                    <div id="fixedAmountInputGroup" class="hidden">
                        <label class="block text-sm font-medium text-gray-700" id="labelFixedAmount">Keuntungan Tetap</label>
                        <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:space-x-4 mt-1">
                            <div class="flex space-x-2 w-full sm:w-2/3">
                                <label for="fixedAmount" class="sr-only">Jumlah</label>
                                <input type="number" id="fixedAmount" value="500" min="-1000000" step="10" class="block w-2/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()" placeholder="Jumlah">
                                <select id="fixedCurrencySelect" onchange="convertFixedAmountValue()" class="block w-1/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="MYR">RM</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="fixedFrequency" class="sr-only">Kekerapan</label>
                                <select id="fixedFrequency" onchange="calculate()" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="day" id="fixedFreqDay">Sehari</option>
                                    <option value="week" selected id="fixedFreqWeek">Seminggu</option>
                                    <option value="month" id="fixedFreqMonth">Sebulan</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Input Group 4: Duration -->
                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" id="titleDuration">Tempoh Pengiraan</h3>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                             <!-- Stacks on mobile, in a row on sm+ -->
                            <div class="flex-grow">
                                <label for="durationValue" class="block text-sm font-medium text-gray-700" id="labelDurationValue">Tempoh (Nilai)</label>
                                <input type="number" id="durationValue" value="52" min="1" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()">
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="durationUnit" class="block text-sm font-medium text-gray-700" id="labelDurationUnit">Unit</label>
                                <select id="durationUnit" onchange="calculate()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="days" id="durationUnitDays">Hari</option>
                                    <option value="weeks" selected id="durationUnitWeeks">Minggu</option>
                                    <option value="months" id="durationUnitMonths">Bulan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Results Section -->
                <div class="mt-8 pt-6 border-t border-gray-200 space-y-4" id="resultsSection">
                    <h3 class="text-xl font-semibold text-gray-800" id="titleResults">Keputusan Pengiraan</h3>
                    
                    <!-- Current Rate Display -->
                    <p class="text-sm text-gray-500 italic" id="currentExchangeRateDisplay"></p>

                    <!-- Primary Result (Shows Profit) -->
                    <div id="primaryResultDisplay" class="result-box p-4 rounded-lg"> 
                        <span class="block text-sm font-medium" id="resultLabel">Keuntungan Setelah Tempoh</span>
                        <div class="font-bold text-2xl mt-1" id="annualProfitResult">RM 0.00</div>
                    </div>
                    
                    <!-- Secondary Result (Shows Total Amount) -->
                    <div id="totalAmountDisplay" class="result-box p-4 rounded-lg">
                        <span class="block text-sm font-medium" id="labelTotalAmount">Jumlah Akhir (Modal + Untung)</span>
                        <div class="font-bold text-2xl mt-1" id="totalAmountResult">RM 0.00</div>
                    </div>

                    <!-- Chart Canvas -->
                    <div class="mt-4 p-4 bg-white rounded-lg border border-gray-200 shadow-inner">
                        <h4 class="text-base font-semibold text-gray-700 mb-2" id="chartTitle">Graf Baki Akhir Mingguan</h4>
                        <canvas id="profitChartCanvas"></canvas>
                    </div>
                    
                    <!-- Export Options -->
                    <div class="flex flex-col sm:flex-row gap-4 pt-4 border-t border-gray-100">
                        <button id="exportCsvBtn" onclick="exportResults('csv')" class="w-full sm:w-1/2 bg-secondary text-gray-900 font-bold py-3 px-4 rounded-lg hover:bg-secondary/80 transition duration-150 shadow-md flex items-center justify-center">
                            <!-- SVG for CSV file icon -->
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.5 13.5H8.5v-2h7v2zm0-4H8.5v-2h7v2z" fill="#059669"/></svg>
                            <span id="exportCsvLabel">Eksport ke CSV</span>
                        </button>
                        <button id="exportPdfBtn" onclick="exportResults('pdf')" class="w-full sm:w-1/2 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition duration-150 shadow-md flex items-center justify-center">
                            <!-- SVG for Printer icon (used for print-to-PDF) -->
                            <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M19 8H5a3 3 0 00-3 3v6h4v4h12v-4h4v-6a3 3 0 00-3-3zM8 12h8v4H8v-4zm7-4v2H9V8h6zm2-4H7V2h10v2z" fill="#374151"/></svg>
                            <span id="exportPdfLabel">Eksport ke PDF (Cetak)</span>
                        </button>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // Constants for conversion (assuming 52 weeks/year and average 4.333 weeks/month)
        const DAYS_PER_WEEK = 7;
        const WEEKS_PER_MONTH = 52 / 12; 
        const WEEKS_PER_YEAR = 52;

        let currentLang = 'ms'; // Default language (MS)
        let rateSource = 'initial'; // 'initial' (default value), 'manual' (user modified)
        let profitChart = null; // Chart.js instance

        // --- Basic Calculator State ---
        let currentInput = '0';
        let previousValue = 0;
        let operation = null;
        let waitingForNewInput = true;
        // ------------------------------


        // Translation dictionary for all static text elements
        const translations = {
            'ms': {
                headerTitle: 'Kalkulator Keuntungan Fleksibel',
                headerSubtitle: 'Kira pulangan berdasarkan kadar yang fleksibel untuk tempoh masa yang anda pilih.',
                cardTitle: 'Pengiraan Keuntungan',
                labelExchangeRateTitle: 'Kadar Tukaran (1 RM = USD)',
                labelExchangeRateSubtitle: 'Kadar ini ditetapkan secara manual.',
                labelPrincipal: 'Modal Awal',
                labelCalcType: 'Pilih Cara Kira Keuntungan',
                radioPercentage: 'Peratusan (%)',
                radioFixed: 'Jumlah Tetap',
                labelRate: 'Peratus Keuntungan (%)',
                labelFixedAmount: 'Keuntungan Tetap',
                rateFreqDay: 'Sehari',
                rateFreqWeek: 'Seminggu',
                rateFreqMonth: 'Sebulan',
                fixedFreqDay: 'Sehari',
                fixedFreqWeek: 'Seminggu',
                fixedFreqMonth: 'Sebulan',
                titleDuration: 'Tempoh Pengiraan',
                labelDurationValue: 'Tempoh (Nilai)',
                labelDurationUnit: 'Unit',
                durationUnitDays: 'Hari',
                durationUnitWeeks: 'Minggu',
                durationUnitMonths: 'Bulan',
                titleResults: 'Keputusan Pengiraan',
                labelTotalAmount: 'Jumlah Akhir (Modal + Untung)',
                resultLabelInitial: 'Keuntungan Setelah Tempoh',
                resultLabelFixedSuffix: ' (Jumlah Tetap)',
                sourceManual: ' (Diubah Manual)',
                chartTitle: 'Graf Baki Akhir Mingguan',
                exportCsvLabel: 'Eksport ke CSV',
                exportPdfLabel: 'Eksport ke PDF (Cetak)',
                toggleCalcBtnTitle: 'Buka Kalkulator Asas', // Added for tooltip
                currentRateFormat: (rate) => {
                    let sourceText = rateSource === 'manual' ? translations[currentLang].sourceManual : '';
                    return `Kadar semasa: 1 RM = ${rate} USD${sourceText}`;
                },
                chartYLabel: 'Baki Akhir',
                chartXLabel: 'Minggu',
                csvFileName: 'Laporan_Keuntungan.csv',
                copyToPrincipalOption: 'Salin ke Modal Awal',
                copyToRateOption: 'Salin ke Peratus Keuntungan',
                copyToFixedOption: 'Salin ke Jumlah Tetap',
                copyToDurationOption: 'Salin ke Tempoh (Nilai)',
                copyToInputBtn: 'Salin & Tutup'
            },
            'en': {
                headerTitle: 'Flexible Profit Calculator',
                headerSubtitle: 'Calculate returns based on flexible rates for your chosen duration.',
                cardTitle: 'Profit Calculation',
                labelExchangeRateTitle: 'Exchange Rate (1 MYR = USD)',
                labelExchangeRateSubtitle: 'This rate is set manually.',
                labelPrincipal: 'Initial Capital',
                labelCalcType: 'Choose Calculation Method',
                radioPercentage: 'Percentage (%)',
                radioFixed: 'Fixed Amount',
                labelRate: 'Profit Percentage (%)',
                labelFixedAmount: 'Fixed Profit',
                rateFreqDay: 'Daily',
                rateFreqWeek: 'Weekly',
                rateFreqMonth: 'Monthly',
                fixedFreqDay: 'Daily',
                fixedFreqWeek: 'Weekly',
                fixedFreqMonth: 'Monthly',
                titleDuration: 'Calculation Period',
                labelDurationValue: 'Duration (Value)',
                labelDurationUnit: 'Unit',
                durationUnitDays: 'Days',
                durationUnitWeeks: 'Weeks',
                durationUnitMonths: 'Months',
                titleResults: 'Calculation Results',
                labelTotalAmount: 'Final Total (Capital + Profit)',
                resultLabelInitial: 'Profit After Period',
                resultLabelFixedSuffix: ' (Fixed Amount)',
                sourceManual: ' (Manually Overwritten)',
                chartTitle: 'Weekly Final Balance Chart',
                exportCsvLabel: 'Export to CSV',
                exportPdfLabel: 'Export to PDF (Print)',
                toggleCalcBtnTitle: 'Open Basic Calculator', // Added for tooltip
                currentRateFormat: (rate) => {
                    let sourceText = rateSource === 'manual' ? translations[currentLang].sourceManual : '';
                    return `Current rate: 1 MYR = ${rate} USD${sourceText}`;
                },
                chartYLabel: 'Final Balance',
                chartXLabel: 'Week',
                csvFileName: 'Profit_Report.csv',
                copyToPrincipalOption: 'Copy to Initial Capital',
                copyToRateOption: 'Copy to Profit Percentage',
                copyToFixedOption: 'Copy to Fixed Amount',
                copyToDurationOption: 'Copy to Duration (Value)',
                copyToInputBtn: 'Copy & Close'
            }
        };

        /**
         * @function getExchangeRates
         * Reads the manually set RM to USD rate and calculates the inverse.
         * @returns {{RM_TO_USD_RATE: number, USD_TO_RM_RATE: number}} - Object containing both rates.
         */
        function getExchangeRates() {
            const rmToUsdInput = parseFloat(document.getElementById('exchangeRateInput').value) || 0.0;
            // Ensure the rate is positive and reasonable, default to 0.2134 (initial value) if input is invalid
            const rmToUsd = rmToUsdInput > 0.0001 ? rmToUsdInput : 0.2134; 
            const usdTorm = 1 / rmToUsd;
            return { RM_TO_USD_RATE: rmToUsd, USD_TO_RM_RATE: usdTorm };
        }

        /**
         * @function toggleLanguage
         * Switches the current language between Malay and English based on the toggle switch state.
         */
        function toggleLanguage() {
            const langSwitch = document.getElementById('lang-switch');
            const labelMS = document.getElementById('label-ms');
            const labelEN = document.getElementById('label-en');

            currentLang = langSwitch.checked ? 'en' : 'ms';

            // Toggle Text Colors based on active language (text inside white slider is primary color)
            if (currentLang === 'en') {
                labelMS.classList.remove('text-primary');
                labelMS.classList.add('text-white');
                labelEN.classList.remove('text-white');
                labelEN.classList.add('text-primary');
            } else {
                labelMS.classList.remove('text-white');
                labelMS.classList.add('text-primary');
                labelEN.classList.remove('text-primary');
                labelEN.classList.add('text-white');
            }

            updateUI(currentLang);
            calculate();
        }

        /**
         * @function updateUI
         * Updates all text elements on the page based on the selected language.
         * @param {string} lang - The language code ('ms' or 'en').
         */
        function updateUI(lang) {
            const t = translations[lang];

            // Update all simple text IDs
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('cardTitle').textContent = t.cardTitle;
            document.getElementById('labelPrincipal').textContent = t.labelPrincipal;
            document.getElementById('labelCalcType').textContent = t.labelCalcType;
            document.getElementById('radioPercentage').textContent = t.radioPercentage;
            document.getElementById('radioFixed').textContent = t.radioFixed;
            document.getElementById('labelRate').textContent = t.labelRate;
            document.getElementById('labelFixedAmount').textContent = t.labelFixedAmount;
            document.getElementById('titleDuration').textContent = t.titleDuration;
            document.getElementById('labelDurationValue').textContent = t.labelDurationValue;
            document.getElementById('labelDurationUnit').textContent = t.labelDurationUnit;
            document.getElementById('titleResults').textContent = t.titleResults;
            document.getElementById('labelTotalAmount').textContent = t.labelTotalAmount;
            document.getElementById('labelExchangeRateTitle').textContent = t.labelExchangeRateTitle;
            document.getElementById('labelExchangeRateSubtitle').textContent = t.labelExchangeRateSubtitle;
            document.getElementById('chartTitle').textContent = t.chartTitle;
            document.getElementById('exportCsvLabel').textContent = t.exportCsvLabel;
            document.getElementById('exportPdfLabel').textContent = t.exportPdfLabel;
            
            // Update Basic Calculator Toggle Button Title/Tooltip (FIXED HERE)
            document.getElementById('toggleCalcBtn').title = t.toggleCalcBtnTitle;


            // Update Select Options (Frequencies and Units)
            document.getElementById('rateFreqDay').textContent = t.rateFreqDay;
            document.getElementById('rateFreqWeek').textContent = t.rateFreqWeek;
            document.getElementById('rateFreqMonth').textContent = t.rateFreqMonth;

            document.getElementById('fixedFreqDay').textContent = t.fixedFreqDay;
            document.getElementById('fixedFreqWeek').textContent = t.fixedFreqWeek;
            document.getElementById('fixedFreqMonth').textContent = t.fixedFreqMonth;

            document.getElementById('durationUnitDays').textContent = t.durationUnitDays;
            document.getElementById('durationUnitWeeks').textContent = t.durationUnitWeeks;
            document.getElementById('durationUnitMonths').textContent = t.durationUnitMonths;

            // Update Basic Calculator Options
            document.getElementById('copyToPrincipalOption').textContent = t.copyToPrincipalOption;
            document.getElementById('copyToRateOption').textContent = t.copyToRateOption;
            document.getElementById('copyToFixedOption').textContent = t.copyToFixedOption;
            document.getElementById('copyToDurationOption').textContent = t.copyToDurationOption;
            document.getElementById('copyToInputBtn').textContent = t.copyToInputBtn;
        }

        /**
         * @function formatCurrency
         * Formats a number into the specified currency string.
         * @param {number} value - The number to format.
         * @param {string} currencyCode - 'MYR' or 'USD'.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(value, currencyCode) {
            const locale = currencyCode === 'MYR' ? 'ms-MY' : 'en-US';
            return new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        /**
         * @function getCalculationPeriods
         * Converts the user-defined duration (Days, Weeks, or Months) into total weeks.
         * @returns {number} - Total number of weeks (periods) for calculation.
         */
        function getCalculationPeriods() {
            const durationValue = parseFloat(document.getElementById('durationValue').value) || 0;
            const durationUnit = document.getElementById('durationUnit').value;

            if (durationValue <= 0) return 0;

            let totalWeeks = 0;

            switch (durationUnit) {
                case 'days':
                    totalWeeks = durationValue / DAYS_PER_WEEK;
                    break;
                case 'weeks':
                    totalWeeks = durationValue;
                    break;
                case 'months':
                    totalWeeks = durationValue * WEEKS_PER_MONTH;
                    break;
                default:
                    totalWeeks = 0;
            }
            // Use Math.round to handle floating point issues from WEEKS_PER_MONTH
            return Math.max(0, Math.round(totalWeeks));
        }

        /**
         * @function convertToBaseCurrency
         * Converts a value from its input currency to the base currency (MYR/RM).
         * @param {number} value - The amount to convert.
         * @param {string} fromCurrency - The currency code of the value ('MYR' or 'USD').
         * @returns {number} - Value in the base currency (RM).
         */
        function convertToBaseCurrency(value, fromCurrency) {
            if (fromCurrency === 'USD') {
                const rates = getExchangeRates();
                return value * rates.USD_TO_RM_RATE;
            }
            return value; // Already MYR/RM
        }

        /**
         * @function convertFromBaseCurrency
         * Converts a value from the base currency (MYR/RM) to the target currency.
         * @param {number} value - The amount in MYR (base currency).
         * @param {string} toCurrency - The target currency code ('MYR' or 'USD').
         * @returns {number} - Value in the target currency.
         */
        function convertFromBaseCurrency(value, toCurrency) {
            if (toCurrency === 'USD') {
                const rates = getExchangeRates();
                return value * rates.RM_TO_USD_RATE;
            }
            return value; // Already MYR/RM
        }

        /**
         * @function convertPrincipalValue
         * Converts the principal input value when the currency dropdown changes
         * and updates the input field to reflect the new currency's value.
         */
        function convertPrincipalValue() {
            const principalInput = document.getElementById('principal');
            const currencySelect = document.getElementById('principalCurrencySelect');
            const rates = getExchangeRates();
            
            let currentValue = parseFloat(principalInput.value) || 0;
            const newCurrency = currencySelect.value;
            const previousCurrency = currencySelect.dataset.lastCurrency;

            if (!previousCurrency || previousCurrency === newCurrency) {
                currencySelect.dataset.lastCurrency = newCurrency;
                calculate();
                return;
            }
            
            let convertedValue = currentValue;

            if (previousCurrency === 'MYR' && newCurrency === 'USD') {
                convertedValue = currentValue * rates.RM_TO_USD_RATE;
            } else if (previousCurrency === 'USD' && newCurrency === 'MYR') {
                convertedValue = currentValue * rates.USD_TO_RM_RATE;
            }

            principalInput.value = convertedValue.toFixed(2);
            currencySelect.dataset.lastCurrency = newCurrency;
            
            calculate();
        }

        /**
         * @function convertFixedAmountValue
         * Converts the fixed amount input value when the currency dropdown changes
         * and updates the input field to reflect the new currency's value.
         */
        function convertFixedAmountValue() {
            const fixedInput = document.getElementById('fixedAmount');
            const currencySelect = document.getElementById('fixedCurrencySelect');
            const rates = getExchangeRates();
            
            let currentValue = parseFloat(fixedInput.value) || 0;
            const newCurrency = currencySelect.value;
            const previousCurrency = currencySelect.dataset.lastCurrency;

            if (!previousCurrency || previousCurrency === newCurrency) {
                currencySelect.dataset.lastCurrency = newCurrency;
                calculate();
                return;
            }
            
            let convertedValue = currentValue;

            if (previousCurrency === 'MYR' && newCurrency === 'USD') {
                convertedValue = currentValue * rates.RM_TO_USD_RATE;
            } else if (previousCurrency === 'USD' && newCurrency === 'MYR') {
                convertedValue = currentValue * rates.USD_TO_RM_RATE;
            }

            fixedInput.value = convertedValue.toFixed(2);
            currencySelect.dataset.lastCurrency = newCurrency;
            
            calculate();
        }


        /**
         * @function toggleCalculationType
         * Hides/shows the relevant input group (Rate or Fixed Amount) based on radio button selection.
         */
        function toggleCalculationType() {
            const type = document.querySelector('input[name="profitType"]:checked').value;
            const percentageGroup = document.getElementById('percentageInputGroup');
            const fixedGroup = document.getElementById('fixedAmountInputGroup');
            
            if (type === 'percentage') {
                percentageGroup.classList.remove('hidden');
                fixedGroup.classList.add('hidden');
            } else { // type === 'fixed'
                percentageGroup.classList.add('hidden');
                fixedGroup.classList.remove('hidden');
            }
            calculate(); // Recalculate immediately
        }

        /**
         * @function updateExchangeRateDisplay
         * Updates the text showing the current exchange rate used and its source.
         */
        function updateExchangeRateDisplay() {
            const rates = getExchangeRates();
            const rmToUsd = rates.RM_TO_USD_RATE.toFixed(4); // Display 4 decimal places for precision
            document.getElementById('currentExchangeRateDisplay').textContent = translations[currentLang].currentRateFormat(rmToUsd);
        }

        /**
         * @function applyResultStyling
         * Toggles between profit (green) and loss (red) styling for result boxes AND the main card.
         * @param {boolean} isLoss - True if the profit is negative, false otherwise.
         */
        function applyResultStyling(isLoss) {
            // Tailwind classes for success (Green - Primary) and loss (Red) states
            const profitClasses = ['bg-primary/10', 'border-primary/20', 'text-primary'];
            const lossClasses = ['bg-red-100', 'border-red-300', 'text-loss']; // using custom 'loss' color

            // 1. Logic for Result Boxes
            const resultElements = [
                document.getElementById('primaryResultDisplay'),
                document.getElementById('totalAmountDisplay')
            ];
            const valueElements = [
                document.getElementById('annualProfitResult'),
                document.getElementById('totalAmountResult'),
                document.getElementById('resultLabel'), 
                document.getElementById('labelTotalAmount') 
            ];

            resultElements.forEach(el => {
                profitClasses.slice(0, 2).forEach(c => el.classList.toggle(c, !isLoss));
                lossClasses.slice(0, 2).forEach(c => el.classList.toggle(c, isLoss));
                el.classList.toggle('result-box-profit', !isLoss);
                el.classList.toggle('result-box-loss', isLoss);
                el.classList.add('border');
            });

            valueElements.forEach(el => {
                profitClasses.slice(2).forEach(c => el.classList.toggle(c, !isLoss));
                lossClasses.slice(2).forEach(c => el.classList.toggle(c, isLoss));
            });

            // 2. Logic for Main Card
            const mainCard = document.getElementById('annual-profit-calculator');
            mainCard.classList.toggle('border-primary', !isLoss);
            mainCard.classList.toggle('border-loss', isLoss); 
            mainCard.classList.toggle('card-profit-glow', !isLoss);
            mainCard.classList.toggle('card-loss-glow', isLoss);
            document.getElementById('cardTitle').classList.toggle('text-primary', !isLoss);
            document.getElementById('cardTitle').classList.toggle('text-loss', isLoss);
        }
        
        /**
         * @function setupChart
         * Initializes or updates the Chart.js chart with new balance data.
         * @param {Array<number>} balanceData - Weekly balance points (in principal currency).
         * @param {string} currencyCode - The currency code for the Y-axis label.
         */
        function setupChart(balanceData, currencyCode) {
            const ctx = document.getElementById('profitChartCanvas').getContext('2d');
            const totalWeeks = balanceData.length - 1; 
            const labels = Array.from({length: totalWeeks + 1}, (_, i) => i);
            const isLoss = balanceData[balanceData.length - 1] < balanceData[0];
            const datasetColor = isLoss ? '#dc2626' : '#059669'; // loss vs primary

            const t = translations[currentLang];

            // Destroy existing chart if it exists
            if (profitChart) {
                profitChart.destroy();
            }

            profitChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // Week 0, 1, 2, ... totalWeeks
                    datasets: [{
                        label: `${t.chartYLabel} (${currencyCode})`,
                        data: balanceData,
                        borderColor: datasetColor,
                        backgroundColor: isLoss ? 'rgba(220, 38, 38, 0.1)' : 'rgba(5, 150, 105, 0.1)',
                        tension: 0.3, // Curve smoothing
                        borderWidth: 2,
                        fill: true,
                        pointRadius: totalWeeks > 52 ? 0 : 3, // Hide points if too many weeks
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${t.chartYLabel}: ${formatCurrency(context.parsed.y, currencyCode)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: `${t.chartYLabel} (${currencyCode})`,
                                color: '#374151',
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value, currencyCode).replace(currencyCode, ''); // Remove currency code for compact axis
                                }
                            },
                            beginAtZero: true
                        },
                        x: {
                            title: {
                                display: true,
                                text: t.chartXLabel,
                                color: '#374151',
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                autoSkipPadding: 20
                            }
                        }
                    }
                }
            });
        }

        /**
         * @function calculate
         * Calculates profit and total amount, converting inputs to the base currency (RM) and
         * converting final results back to the principal currency for display.
         */
        function calculate() {
            const t = translations[currentLang];
            const type = document.querySelector('input[name="profitType"]:checked').value;
            
            // Update the display of the current rate
            updateExchangeRateDisplay();
            
            // Get currency selection for display
            const principalCurrencyCode = document.getElementById('principalCurrencySelect').value;
            
            // 1. Convert ALL inputs to the Base Currency (MYR/RM)
            const principalInput = parseFloat(document.getElementById('principal').value) || 0;
            const principalInputCurrency = document.getElementById('principalCurrencySelect').value;
            const principalRM = convertToBaseCurrency(principalInput, principalInputCurrency);

            const totalWeeks = getCalculationPeriods();

            const annualProfitResult = document.getElementById('annualProfitResult');
            const totalAmountResult = document.getElementById('totalAmountResult');
            const resultLabel = document.getElementById('resultLabel');
            
            // Duration Text
            const durationValue = document.getElementById('durationValue').value;
            const durationUnitElement = document.getElementById('durationUnit').options[document.getElementById('durationUnit').selectedIndex];
            const durationUnitKey = 'durationUnit' + durationUnitElement.value.charAt(0).toUpperCase() + durationUnitElement.value.slice(1);
            const durationUnitText = t[durationUnitKey]; 

            let newLabel = `${t.resultLabelInitial} ${durationValue} ${durationUnitText}`;

            let profitRM = 0;
            let totalAmountRM = principalRM;
            let weeklyBalancesRM = [principalRM]; // For chart data (Week 0)

            if (type === 'percentage') {
                const ratePercent = parseFloat(document.getElementById('rate').value) || 0;
                const rateFrequency = document.getElementById('rateFrequency').value;
                
                let ratePerWeek = 0; 

                if (principalRM > 0) { 
                    const rateDecimal = ratePercent / 100;
                    
                    // Discrete Compounding Logic (Compounding at the end of each period)
                    if (rateFrequency === 'day') {
                        // Convert daily rate to weekly effective rate
                        ratePerWeek = Math.pow(1 + rateDecimal, DAYS_PER_WEEK) - 1;
                    } else if (rateFrequency === 'week') {
                        // Weekly rate is the base rate
                        ratePerWeek = rateDecimal;
                    } else if (rateFrequency === 'month') {
                        // Convert monthly rate to weekly effective rate
                        ratePerWeek = Math.pow(1 + rateDecimal, 1 / WEEKS_PER_MONTH) - 1;
                    }
                    
                    // A = P * (1 + i)^n
                    totalAmountRM = principalRM * Math.pow(1 + ratePerWeek, totalWeeks);

                    // Calculate weekly points for chart
                    let currentBalance = principalRM;
                    for (let week = 1; week <= totalWeeks; week++) {
                        currentBalance *= (1 + ratePerWeek);
                        weeklyBalancesRM.push(currentBalance);
                    }

                    profitRM = totalAmountRM - principalRM;

                } else {
                    totalAmountRM = principalRM;
                    profitRM = 0;
                }

            } else { // type === 'fixed'
                newLabel += t.resultLabelFixedSuffix;
                
                // Fixed Amount Input (Convert to RM)
                const fixedAmountInput = parseFloat(document.getElementById('fixedAmount').value) || 0;
                const fixedInputCurrency = document.getElementById('fixedCurrencySelect').value;
                const fixedAmountRM = convertToBaseCurrency(fixedAmountInput, fixedInputCurrency);

                const fixedFrequency = document.getElementById('fixedFrequency').value;

                let weeklyFixedProfitRM = 0;

                if (fixedFrequency === 'day') {
                    weeklyFixedProfitRM = fixedAmountRM * DAYS_PER_WEEK;
                } else if (fixedFrequency === 'week') {
                    weeklyFixedProfitRM = fixedAmountRM;
                } else if (fixedFrequency === 'month') {
                    weeklyFixedProfitRM = fixedAmountRM / WEEKS_PER_MONTH; 
                }
                
                if (totalWeeks > 0) {
                    profitRM = weeklyFixedProfitRM * totalWeeks;
                    totalAmountRM = principalRM + profitRM;

                    // Calculate weekly points for chart (linear growth)
                    for (let week = 1; week <= totalWeeks; week++) {
                        const balance = principalRM + (weeklyFixedProfitRM * week);
                        weeklyBalancesRM.push(balance);
                    }
                } else {
                    profitRM = 0;
                    totalAmountRM = principalRM;
                }
            }
            
            // 2. Convert Final Results from Base Currency (RM) to Display Currency
            const profitDisplay = convertFromBaseCurrency(profitRM, principalCurrencyCode);
            const totalAmountDisplay = convertFromBaseCurrency(totalAmountRM, principalCurrencyCode);
            
            // Convert weekly balances to display currency for the chart
            const weeklyBalancesDisplay = weeklyBalancesRM.map(balance => convertFromBaseCurrency(balance, principalCurrencyCode));

            // Check for loss to apply red styling
            const isLoss = profitDisplay < 0;
            applyResultStyling(isLoss);


            // 3. Update Result Displays
            resultLabel.textContent = newLabel;
            annualProfitResult.textContent = formatCurrency(profitDisplay, principalCurrencyCode);
            totalAmountResult.textContent = formatCurrency(totalAmountDisplay, principalCurrencyCode);
            
            // 4. Update Chart
            setupChart(weeklyBalancesDisplay, principalCurrencyCode);
        }

        /**
         * @function exportResults
         * Exports calculation results as CSV or triggers print for PDF.
         * @param {string} format - 'csv' or 'pdf'.
         */
        function exportResults(format) {
            const t = translations[currentLang];
            const principalCurrencyCode = document.getElementById('principalCurrencySelect').value;
            const rates = getExchangeRates();

            if (format === 'csv') {
                const finalProfitText = document.getElementById('annualProfitResult').textContent;
                const totalAmountText = document.getElementById('totalAmountResult').textContent;
                const durationText = document.getElementById('resultLabel').textContent.split(t.resultLabelInitial + ' ')[1] || '';
                const type = document.querySelector('input[name="profitType"]:checked').value;
                
                let calculationDetails = '';
                if (type === 'percentage') {
                    const rate = document.getElementById('rate').value;
                    const freq = document.getElementById('rateFrequency').value;
                    calculationDetails = `${rate}% / ${t['rateFreq' + freq.charAt(0).toUpperCase() + freq.slice(1)]}`;
                } else {
                    const fixed = document.getElementById('fixedAmount').value;
                    const fixedCurr = document.getElementById('fixedCurrencySelect').value;
                    const freq = document.getElementById('fixedFrequency').value;
                    calculationDetails = `${fixedCurr} ${fixed} / ${t['fixedFreq' + freq.charAt(0).toUpperCase() + freq.slice(1)]}`;
                }


                let csvContent = `Data,Nilai,Unit\n`;
                csvContent += `${t.labelPrincipal},${document.getElementById('principal').value},${principalCurrencyCode}\n`;
                csvContent += `${t.titleDuration} (${t.labelDurationValue} ${t.labelDurationUnit}),${durationText},N/A\n`;
                csvContent += `${t.labelCalcType},${calculationDetails},N/A\n`;
                csvContent += `${t.labelExchangeRateTitle},1 RM = ${rates.RM_TO_USD_RATE.toFixed(4)},USD\n`;
                csvContent += `\n`;
                csvContent += `${t.resultLabelInitial},${finalProfitText.replace(/[^0-9.-]/g, '')},${principalCurrencyCode}\n`;
                csvContent += `${t.labelTotalAmount},${totalAmountText.replace(/[^0-9.-]/g, '')},${principalCurrencyCode}\n`;

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.setAttribute('download', t.csvFileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } else if (format === 'pdf') {
                // Use browser's built-in print functionality
                window.print();
            }
        }

        // --- Basic Calculator Functions ---

        /**
         * @function toggleBasicCalculator
         * Shows or hides the floating basic calculator modal with smooth transition.
         */
        function toggleBasicCalculator() {
            const wrapper = document.getElementById('basicCalculatorWrapper');

            if (wrapper.classList.contains('active')) {
                // Closing sequence:
                wrapper.classList.remove('active'); // Start transition to opacity: 0
                // Wait for transition (0.3s) before setting display: none (via hidden class)
                setTimeout(() => {
                    wrapper.classList.add('hidden'); 
                }, 300); // Matches the CSS transition duration
            } else {
                // Opening sequence:
                wrapper.classList.remove('hidden'); // Set display: flex
                // Allow brief moment for layout/reflow before starting transition
                setTimeout(() => {
                    wrapper.classList.add('active'); // Transition to opacity: 1
                }, 10);
                
                // Reset calculator state when opening
                calcClear();
            }
        }

        /**
         * @function updateCalcDisplay
         * Updates the calculator display with the current input string.
         */
        function updateCalcDisplay() {
            document.getElementById('calcDisplay').value = currentInput;
        }

        /**
         * @function calcClear
         * Resets the calculator state.
         */
        function calcClear() {
            currentInput = '0';
            previousValue = 0;
            operation = null;
            waitingForNewInput = true;
            updateCalcDisplay();
        }

        /**
         * @function calcInput
         * Handles numerical and decimal point input, and operator selection.
         * @param {string} value - The button value (0-9, ., +, -, *, /).
         */
        function calcInput(value) {
            const display = document.getElementById('calcDisplay');

            if (waitingForNewInput && isFinite(value)) {
                // Start new input if it's a number and we were waiting for it (e.g., after equals or operator press)
                currentInput = value;
                waitingForNewInput = false;
            } else if (isFinite(value)) {
                // Append number
                if (currentInput === '0') {
                    currentInput = value;
                } else {
                    currentInput += value;
                }
            } else if (value === '.') {
                // Append decimal point
                if (waitingForNewInput) {
                    currentInput = '0.';
                    waitingForNewInput = false;
                } else if (!currentInput.includes('.')) {
                    currentInput += '.';
                }
            } else {
                // Handle Operator (+, -, *, /)
                if (operation && !waitingForNewInput) {
                    // Calculate previous result if an operation was pending
                    calcEquals(); 
                    previousValue = parseFloat(currentInput);
                } else if (!operation) {
                    previousValue = parseFloat(currentInput);
                }
                
                operation = value;
                waitingForNewInput = true;
            }
            updateCalcDisplay();
        }

        /**
         * @function calcEquals
         * Executes the pending operation and updates the display.
         */
        function calcEquals() {
            if (operation === null || waitingForNewInput) {
                // Do nothing if no operation is set or waiting for a new number
                return;
            }

            const currentValue = parseFloat(currentInput);
            let result = 0;

            try {
                switch (operation) {
                    case '+':
                        result = previousValue + currentValue;
                        break;
                    case '-':
                        result = previousValue - currentValue;
                        break;
                    case '*':
                        result = previousValue * currentValue;
                        break;
                    case '/':
                        if (currentValue === 0) {
                             currentInput = "Error: Div by 0";
                             updateCalcDisplay();
                             return;
                        }
                        result = previousValue / currentValue;
                        break;
                    default:
                        return;
                }
                
                // Format result to a maximum of 10 decimal places to prevent float issues
                currentInput = parseFloat(result.toFixed(10)).toString();
                previousValue = result;
                operation = null;
                waitingForNewInput = true;
            } catch (e) {
                currentInput = 'Error';
            }
            
            updateCalcDisplay();
        }

        /**
         * @function copyBasicCalcResult
         * Copies the final result from the basic calculator to the selected input field
         * in the main profit calculator and closes the modal automatically.
         */
        function copyBasicCalcResult() {
            // 1. Finalize the calculation
            calcEquals(); 
            
            const resultValue = parseFloat(currentInput);
            const targetId = document.getElementById('copyTargetSelect').value;
            const targetInput = document.getElementById(targetId);

            if (targetInput && isFinite(resultValue)) {
                // 2. Determine rounding based on target input type
                let roundedValue;
                if (targetId === 'durationValue') {
                    roundedValue = Math.round(resultValue);
                } else {
                    // For financial/percentage inputs, round to 2 decimal places
                    roundedValue = resultValue.toFixed(2);
                }

                targetInput.value = roundedValue;

                // 3. Trigger calculation in the main app to update results
                calculate();
            }

            // 4. Automatically close the calculator modal
            toggleBasicCalculator();
        }

        // Start calculation and update UI when the page loads
        window.onload = () => {
            // Set initial calculation type
            toggleCalculationType();
            
            // Initialize the last currency state for the auto-conversion feature
            document.getElementById('principalCurrencySelect').dataset.lastCurrency = document.getElementById('principalCurrencySelect').value;
            document.getElementById('fixedCurrencySelect').dataset.lastCurrency = document.getElementById('fixedCurrencySelect').value;

            // Set initial language UI (MS default). 
            const langSwitch = document.getElementById('lang-switch');
            langSwitch.checked = false; 
            toggleLanguage(); // Call this to set the initial state colors, labels, and tooltips
            
            // Add event listener to detect manual rate changes
            document.getElementById('exchangeRateInput').addEventListener('input', () => {
                rateSource = 'manual';
                calculate(); 
            });

            // Add listener to other inputs/selects that now call calculate()
            document.getElementById('principal').oninput = calculate;
            document.getElementById('rate').oninput = calculate;
            document.getElementById('fixedAmount').oninput = calculate;
            document.getElementById('durationValue').oninput = calculate;
            
            // Perform initial calculation
            calculate(); 
        };

    </script>
</body>
</html>
