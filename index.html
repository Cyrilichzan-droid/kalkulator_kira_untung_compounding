<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Keuntungan Tahunan</title>
    <!-- Link to the Web App Manifest for PWA features -->
    <link rel="manifest" href="manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and define custom loss color -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#059669', // Emerald 600 (Green - Profit)
                        'secondary': '#facc15', // Amber 400
                        'loss': '#dc2626', // Red 600 (New color for loss)
                        'background': '#f3f4f6', // Gray 100
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        
        /* Custom styles for the main card */
        .card {
            /* Standard shadow */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.5s ease;
        }

        /* Dynamic Glow Effect for the main card */
        
        /* Green Glow for Profit Card */
        .card-profit-glow:hover { 
            transform: translateY(-2px);
            /* Brighter green glow (primary color) */
            box-shadow: 0 0 40px rgba(5, 150, 105, 0.4), 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        }

        /* Red Glow for Loss Card */
        .card-loss-glow:hover {
            transform: translateY(-2px);
            /* Brighter red glow (loss color) */
            box-shadow: 0 0 40px rgba(220, 38, 38, 0.4), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Base style for result boxes */
        .result-box {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); 
        }

        /* Green Glow for Profit Result Box */
        .result-box-profit:hover {
            box-shadow: 0 0 15px rgba(5, 150, 105, 0.6); 
        }
        
        /* Red Glow for Loss Result Box */
        .result-box-loss:hover {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.6); /* Using loss color #dc2626 */
        }

        /* Hide default number input controls */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Custom styles for the language toggle switch */
        /* Move slider to the right when checkbox is checked (EN mode) */
        #lang-switch:checked + label #slider {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <!-- Container is fluid on mobile and centered/max-width on desktop -->
    <div class="w-full max-w-4xl space-y-8">
        <header class="text-center relative">
            <!-- Language Toggle Switch (Positioned absolutely on top right) -->
            <div class="absolute top-0 right-0 w-24 h-8">
                <input type="checkbox" id="lang-switch" class="hidden" onchange="toggleLanguage()">
                <label for="lang-switch" class="relative block w-full h-full bg-primary rounded-full cursor-pointer transition duration-300">
                    <!-- Sliding Indicator -->
                    <div id="slider" class="absolute top-0 left-0 w-1/2 h-full bg-white rounded-full shadow-md transform transition-transform duration-300 ease-in-out"></div>
                    <!-- Text Labels -->
                    <div class="absolute inset-0 flex items-center justify-start text-xs font-bold pointer-events-none">
                        <span id="label-ms" class="w-1/2 text-center z-10 transition duration-150">MS</span>
                        <span id="label-en" class="w-1/2 text-center z-10 transition duration-150">EN</span>
                    </div>
                </label>
            </div>
            
            <!-- Adjusted title size for better mobile fit and margin to clear toggle switch -->
            <h1 class="text-2xl sm:text-4xl font-extrabold text-primary mb-2 mt-12 sm:mt-0" id="headerTitle">Kalkulator Keuntungan Fleksibel</h1>
            <p class="text-gray-600 text-base sm:text-lg" id="headerSubtitle">Kira pulangan berdasarkan kadar yang fleksibel untuk tempoh masa yang anda pilih.</p>
        </header>

        <main class="flex justify-center">
            <!-- Combined Calculator Card: Max width set to lg (56rem) to keep it compact on desktop -->
            <div id="annual-profit-calculator" class="card bg-white p-6 sm:p-8 rounded-xl border-t-8 border-primary card-profit-glow w-full max-w-lg">
                <h2 class="text-2xl sm:text-3xl font-bold text-primary mb-6 text-center" id="cardTitle">
                    Pengiraan Keuntungan
                </h2>

                <!-- Exchange Rate Input -->
                <div class="mb-6 p-4 bg-secondary/10 rounded-lg border border-secondary/20">
                    <label for="exchangeRateInput" class="block text-sm font-medium text-gray-700" id="labelExchangeRateTitle">Kadar Tukaran (1 RM = USD)</label>
                    <div class="mt-1 flex space-x-2 items-center">
                        <span class="text-lg font-semibold text-gray-600">1 RM =</span>
                        <div class="relative flex items-center">
                            <!-- Input size is compact but padded for touch -->
                            <!-- oninput is handled in window.onload to track manual changes -->
                            <input type="number" id="exchangeRateInput" value="0.2134" min="0.0001" step="0.0001" class="block w-24 rounded-md border-gray-300 shadow-sm p-3 border focus:border-secondary focus:ring-secondary text-right pr-3">
                        </div>
                        <span class="text-lg font-semibold text-gray-600">USD</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2" id="labelExchangeRateSubtitle">Kadar ini ditetapkan secara manual.</p>
                </div>
                
                <div class="space-y-6">
                    <!-- Input 1: Modal Awal (with Currency Dropdown) -->
                    <div>
                        <label for="principal" class="block text-sm font-medium text-gray-700" id="labelPrincipal">Modal Awal</label>
                        <div class="flex space-x-2 mt-1">
                            <!-- Input and Select are given proportionate widths -->
                            <input type="number" id="principal" value="1000" min="0" step="100" class="block w-2/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()">
                            <select id="principalCurrencySelect" onchange="convertPrincipalValue()" class="block w-1/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                <option value="MYR">RM</option>
                                <option value="USD">USD</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Pilihan Jenis Keuntungan: Already uses flex-col on mobile and flex-row on 'sm' (small screen and up) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" id="labelCalcType">Pilih Cara Kira Keuntungan</label>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-6 bg-gray-50 p-3 rounded-lg">
                            <!-- Radio 1: Percentage -->
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="profitType" value="percentage" checked onclick="toggleCalculationType()" class="form-radio text-primary h-4 w-4 border-gray-300 focus:ring-primary">
                                <span class="ml-2 text-gray-700 font-medium" id="radioPercentage">Peratusan (%)</span>
                            </label>
                            <!-- Radio 2: Fixed Amount -->
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="profitType" value="fixed" onclick="toggleCalculationType()" class="form-radio text-primary h-4 w-4 border-gray-300 focus:ring-primary">
                                <span class="ml-2 text-gray-700 font-medium" id="radioFixed">Jumlah Tetap</span>
                            </label>
                        </div>
                    </div>

                    <!-- Input Group 2: Percentage (Compounding) -->
                    <div id="percentageInputGroup">
                        <label class="block text-sm font-medium text-gray-700" id="labelRate">Peratus Keuntungan (%)</label>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-1">
                            <!-- Stacks on mobile, in a row on sm+ -->
                            <div class="flex-grow">
                                <label for="rate" class="sr-only">Peratus</label>
                                <input type="number" id="rate" value="7" min="-100" max="100" step="0.1" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()" placeholder="Peratus">
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="rateFrequency" class="sr-only">Kekerapan</label>
                                <select id="rateFrequency" onchange="calculate()" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="day" id="rateFreqDay">Sehari</option>
                                    <option value="week" selected id="rateFreqWeek">Seminggu</option>
                                    <option value="month" id="rateFreqMonth">Sebulan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Input Group 3: Fixed Amount -->
                    <div id="fixedAmountInputGroup" class="hidden">
                        <label class="block text-sm font-medium text-gray-700" id="labelFixedAmount">Keuntungan Tetap</label>
                        <div class="flex flex-col space-y-3 sm:space-y-0 sm:flex-row sm:space-x-4 mt-1">
                            <div class="flex space-x-2 w-full sm:w-2/3">
                                <label for="fixedAmount" class="sr-only">Jumlah</label>
                                <input type="number" id="fixedAmount" value="500" min="-1000000" step="10" class="block w-2/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()" placeholder="Jumlah">
                                <select id="fixedCurrencySelect" onchange="convertFixedAmountValue()" class="block w-1/3 rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="MYR">RM</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="fixedFrequency" class="sr-only">Kekerapan</label>
                                <select id="fixedFrequency" onchange="calculate()" class="block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="day" id="fixedFreqDay">Sehari</option>
                                    <option value="week" selected id="fixedFreqWeek">Seminggu</option>
                                    <option value="month" id="fixedFreqMonth">Sebulan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Input Group 4: Duration -->
                    <div class="border-t pt-6 mt-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4" id="titleDuration">Tempoh Pengiraan</h3>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                             <!-- Stacks on mobile, in a row on sm+ -->
                            <div class="flex-grow">
                                <label for="durationValue" class="block text-sm font-medium text-gray-700" id="labelDurationValue">Tempoh (Nilai)</label>
                                <input type="number" id="durationValue" value="52" min="1" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary" oninput="calculate()">
                            </div>
                            <div class="w-full sm:w-1/3">
                                <label for="durationUnit" class="block text-sm font-medium text-gray-700" id="labelDurationUnit">Unit</label>
                                <select id="durationUnit" onchange="calculate()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-primary focus:ring-primary">
                                    <option value="days" id="durationUnitDays">Hari</option>
                                    <option value="weeks" selected id="durationUnitWeeks">Minggu</option>
                                    <option value="months" id="durationUnitMonths">Bulan</option>
                                </select>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Results Section: Good padding and clear text sizes for mobile legibility -->
                <div class="mt-8 pt-6 border-t border-gray-200 space-y-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="titleResults">Keputusan Pengiraan</h3>
                    
                    <!-- Current Rate Display -->
                    <p class="text-sm text-gray-500 italic" id="currentExchangeRateDisplay"></p>

                    <!-- Primary Result (Shows Profit) -->
                    <div id="primaryResultDisplay" class="result-box p-4 rounded-lg"> 
                        <span class="block text-sm font-medium" id="resultLabel">Keuntungan Setelah Tempoh</span>
                        <div class="font-bold text-2xl mt-1" id="annualProfitResult">RM 0.00</div>
                    </div>
                    
                    <!-- Secondary Result (Shows Total Amount) -->
                    <div id="totalAmountDisplay" class="result-box p-4 rounded-lg">
                        <span class="block text-sm font-medium" id="labelTotalAmount">Jumlah Akhir (Modal + Untung)</span>
                        <div class="font-bold text-2xl mt-1" id="totalAmountResult">RM 0.00</div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <script>
        // Constants for conversion (assuming 52 weeks/year and average 4.333 weeks/month)
        const DAYS_PER_WEEK = 7;
        const WEEKS_PER_MONTH = 52 / 12; 
        
        let currentLang = 'ms'; // Default language (MS)
        let rateSource = 'initial'; // 'initial' (default value), 'manual' (user modified)

        // Translation dictionary for all static text elements
        const translations = {
            'ms': {
                headerTitle: 'Kalkulator Keuntungan Fleksibel',
                headerSubtitle: 'Kira pulangan berdasarkan kadar yang fleksibel untuk tempoh masa yang anda pilih.',
                cardTitle: 'Pengiraan Keuntungan',
                labelExchangeRateTitle: 'Kadar Tukaran (1 RM = USD)',
                labelExchangeRateSubtitle: 'Kadar ini ditetapkan secara manual.',
                labelPrincipal: 'Modal Awal',
                labelCalcType: 'Pilih Cara Kira Keuntungan',
                radioPercentage: 'Peratusan (%)',
                radioFixed: 'Jumlah Tetap',
                labelRate: 'Peratus Keuntungan (%)',
                labelFixedAmount: 'Keuntungan Tetap',
                rateFreqDay: 'Sehari',
                rateFreqWeek: 'Seminggu',
                rateFreqMonth: 'Sebulan',
                fixedFreqDay: 'Sehari',
                fixedFreqWeek: 'Seminggu',
                fixedFreqMonth: 'Sebulan',
                titleDuration: 'Tempoh Pengiraan',
                labelDurationValue: 'Tempoh (Nilai)',
                labelDurationUnit: 'Unit',
                durationUnitDays: 'Hari',
                durationUnitWeeks: 'Minggu',
                durationUnitMonths: 'Bulan',
                titleResults: 'Keputusan Pengiraan',
                labelTotalAmount: 'Jumlah Akhir (Modal + Untung)',
                resultLabelInitial: 'Keuntungan Setelah Tempoh',
                resultLabelCompoundingSuffix: ' (Berkompaun)',
                resultLabelFixedSuffix: ' (Jumlah Tetap)',
                sourceManual: ' (Diubah Manual)',
                currentRateFormat: (rate) => {
                    let sourceText = rateSource === 'manual' ? translations[currentLang].sourceManual : '';
                    return `Kadar semasa: 1 RM = ${rate} USD${sourceText}`;
                },
            },
            'en': {
                headerTitle: 'Flexible Profit Calculator',
                headerSubtitle: 'Calculate returns based on flexible rates for your chosen duration.',
                cardTitle: 'Profit Calculation',
                labelExchangeRateTitle: 'Exchange Rate (1 MYR = USD)',
                labelExchangeRateSubtitle: 'This rate is set manually.',
                labelPrincipal: 'Initial Capital',
                labelCalcType: 'Choose Calculation Method',
                radioPercentage: 'Percentage (%)',
                radioFixed: 'Fixed Amount',
                labelRate: 'Profit Percentage (%)',
                labelFixedAmount: 'Fixed Profit',
                rateFreqDay: 'Daily',
                rateFreqWeek: 'Weekly',
                rateFreqMonth: 'Monthly',
                fixedFreqDay: 'Daily',
                fixedFreqWeek: 'Weekly',
                fixedFreqMonth: 'Monthly',
                titleDuration: 'Calculation Period',
                labelDurationValue: 'Duration (Value)',
                labelDurationUnit: 'Unit',
                durationUnitDays: 'Days',
                durationUnitWeeks: 'Weeks',
                durationUnitMonths: 'Months',
                titleResults: 'Calculation Results',
                labelTotalAmount: 'Final Total (Capital + Profit)',
                resultLabelInitial: 'Profit After Period',
                resultLabelCompoundingSuffix: ' (Compounded)',
                resultLabelFixedSuffix: ' (Fixed Amount)',
                sourceManual: ' (Manually Overwritten)',
                currentRateFormat: (rate) => {
                    let sourceText = rateSource === 'manual' ? translations[currentLang].sourceManual : '';
                    return `Current rate: 1 MYR = ${rate} USD${sourceText}`;
                },
            }
        };

        /**
         * @function getExchangeRates
         * Reads the manually set RM to USD rate and calculates the inverse.
         * @returns {{RM_TO_USD_RATE: number, USD_TO_RM_RATE: number}} - Object containing both rates.
         */
        function getExchangeRates() {
            const rmToUsdInput = parseFloat(document.getElementById('exchangeRateInput').value) || 0.0;
            // Ensure the rate is positive and reasonable, default to 0.2134 (initial value) if input is invalid
            const rmToUsd = rmToUsdInput > 0.0001 ? rmToUsdInput : 0.2134; 
            const usdTorm = 1 / rmToUsd;
            return { RM_TO_USD_RATE: rmToUsd, USD_TO_RM_RATE: usdTorm };
        }

        /**
         * @function toggleLanguage
         * Switches the current language between Malay and English based on the toggle switch state.
         */
        function toggleLanguage() {
            const langSwitch = document.getElementById('lang-switch');
            const labelMS = document.getElementById('label-ms');
            const labelEN = document.getElementById('label-en');

            // Determine new language based on checkbox state (checked = EN, unchecked = MS)
            currentLang = langSwitch.checked ? 'en' : 'ms';

            // Toggle Text Colors based on active language (text inside white slider is primary color)
            if (currentLang === 'en') {
                // EN is active (slider is on the right)
                labelMS.classList.remove('text-primary');
                labelMS.classList.add('text-white');
                labelEN.classList.remove('text-white');
                labelEN.classList.add('text-primary');
            } else {
                // MS is active (slider is on the left)
                labelMS.classList.remove('text-white');
                labelMS.classList.add('text-primary');
                labelEN.classList.remove('text-primary');
                labelEN.classList.add('text-white');
            }

            updateUI(currentLang);
            calculate();
        }

        /**
         * @function updateUI
         * Updates all text elements on the page based on the selected language.
         * @param {string} lang - The language code ('ms' or 'en').
         */
        function updateUI(lang) {
            const t = translations[lang];

            // Update all simple text IDs
            document.getElementById('headerTitle').textContent = t.headerTitle;
            document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            document.getElementById('cardTitle').textContent = t.cardTitle;
            document.getElementById('labelPrincipal').textContent = t.labelPrincipal;
            document.getElementById('labelCalcType').textContent = t.labelCalcType;
            document.getElementById('radioPercentage').textContent = t.radioPercentage;
            document.getElementById('radioFixed').textContent = t.radioFixed;
            document.getElementById('labelRate').textContent = t.labelRate;
            document.getElementById('labelFixedAmount').textContent = t.labelFixedAmount;
            document.getElementById('titleDuration').textContent = t.titleDuration;
            document.getElementById('labelDurationValue').textContent = t.labelDurationValue;
            document.getElementById('labelDurationUnit').textContent = t.labelDurationUnit;
            document.getElementById('titleResults').textContent = t.titleResults;
            document.getElementById('labelTotalAmount').textContent = t.labelTotalAmount;
            document.getElementById('labelExchangeRateTitle').textContent = t.labelExchangeRateTitle;
            document.getElementById('labelExchangeRateSubtitle').textContent = t.labelExchangeRateSubtitle;


            // Update Select Options (Frequencies and Units)
            document.getElementById('rateFreqDay').textContent = t.rateFreqDay;
            document.getElementById('rateFreqWeek').textContent = t.rateFreqWeek;
            document.getElementById('rateFreqMonth').textContent = t.rateFreqMonth;

            document.getElementById('fixedFreqDay').textContent = t.fixedFreqDay;
            document.getElementById('fixedFreqWeek').textContent = t.fixedFreqWeek;
            document.getElementById('fixedFreqMonth').textContent = t.fixedFreqMonth;

            document.getElementById('durationUnitDays').textContent = t.durationUnitDays;
            document.getElementById('durationUnitWeeks').textContent = t.durationUnitWeeks;
            document.getElementById('durationUnitMonths').textContent = t.durationUnitMonths;
        }


        /**
         * @function formatCurrency
         * Formats a number into the specified currency string.
         * @param {number} value - The number to format.
         * @param {string} currencyCode - 'MYR' or 'USD'.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(value, currencyCode) {
            const locale = currencyCode === 'MYR' ? 'ms-MY' : 'en-US';
            return new Intl.NumberFormat(locale, {
                style: 'currency',
                currency: currencyCode,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        /**
         * @function getCalculationPeriods
         * Converts the user-defined duration (Days, Weeks, or Months) into total weeks.
         * @returns {number} - Total number of weeks (periods) for calculation.
         */
        function getCalculationPeriods() {
            const durationValue = parseFloat(document.getElementById('durationValue').value) || 0;
            const durationUnit = document.getElementById('durationUnit').value;

            if (durationValue <= 0) return 0;

            let totalWeeks = 0;

            switch (durationUnit) {
                case 'days':
                    totalWeeks = durationValue / DAYS_PER_WEEK;
                    break;
                case 'weeks':
                    totalWeeks = durationValue;
                    break;
                case 'months':
                    totalWeeks = durationValue * WEEKS_PER_MONTH;
                    break;
                default:
                    totalWeeks = 0;
            }
            return Math.max(0, totalWeeks);
        }

        /**
         * @function convertToBaseCurrency
         * Converts a value from its input currency to the base currency (MYR/RM).
         * @param {number} value - The amount to convert.
         * @param {string} fromCurrency - The currency code of the value ('MYR' or 'USD').
         * @returns {number} - Value in the base currency (RM).
         */
        function convertToBaseCurrency(value, fromCurrency) {
            if (fromCurrency === 'USD') {
                const rates = getExchangeRates();
                return value * rates.USD_TO_RM_RATE;
            }
            return value; // Already MYR/RM
        }

        /**
         * @function convertFromBaseCurrency
         * Converts a value from the base currency (MYR/RM) to the target currency.
         * @param {number} value - The amount in MYR (base currency).
         * @param {string} toCurrency - The target currency code ('MYR' or 'USD').
         * @returns {number} - Value in the target currency.
         */
        function convertFromBaseCurrency(value, toCurrency) {
            if (toCurrency === 'USD') {
                const rates = getExchangeRates();
                return value * rates.RM_TO_USD_RATE;
            }
            return value; // Already MYR/RM
        }

        /**
         * @function convertPrincipalValue
         * Converts the principal input value when the currency dropdown changes
         * and updates the input field to reflect the new currency's value.
         */
        function convertPrincipalValue() {
            const principalInput = document.getElementById('principal');
            const currencySelect = document.getElementById('principalCurrencySelect');
            const rates = getExchangeRates();
            
            // Get the value before conversion
            let currentValue = parseFloat(principalInput.value) || 0;
            const newCurrency = currencySelect.value;
            
            // Retrieve the currency *before* the change (stored in data-last-currency)
            const previousCurrency = currencySelect.dataset.lastCurrency;

            if (!previousCurrency || previousCurrency === newCurrency) {
                // If previous currency is not set (initial load) or no change, just calculate
                currencySelect.dataset.lastCurrency = newCurrency;
                calculate();
                return;
            }
            
            let convertedValue = currentValue;

            // Convert FROM the previous currency TO the new currency
            if (previousCurrency === 'MYR' && newCurrency === 'USD') {
                // RM -> USD
                convertedValue = currentValue * rates.RM_TO_USD_RATE;
            } else if (previousCurrency === 'USD' && newCurrency === 'MYR') {
                // USD -> RM
                convertedValue = currentValue * rates.USD_TO_RM_RATE;
            }

            // Update the input field with the new value (rounded to 2 decimal places)
            // Use toFixed() to prevent floating point errors and keep it monetary
            principalInput.value = convertedValue.toFixed(2);
            
            // Store the new currency as the "last" one for the next change event
            currencySelect.dataset.lastCurrency = newCurrency;
            
            // Recalculate all results
            calculate();
        }

        /**
         * @function convertFixedAmountValue
         * Converts the fixed amount input value when the currency dropdown changes
         * and updates the input field to reflect the new currency's value.
         */
        function convertFixedAmountValue() {
            const fixedInput = document.getElementById('fixedAmount');
            const currencySelect = document.getElementById('fixedCurrencySelect');
            const rates = getExchangeRates();
            
            // Get the value before conversion
            let currentValue = parseFloat(fixedInput.value) || 0;
            const newCurrency = currencySelect.value;
            
            // Retrieve the currency *before* the change (stored in data-last-currency)
            const previousCurrency = currencySelect.dataset.lastCurrency;

            if (!previousCurrency || previousCurrency === newCurrency) {
                currencySelect.dataset.lastCurrency = newCurrency;
                calculate();
                return;
            }
            
            let convertedValue = currentValue;

            // Convert FROM the previous currency TO the new currency
            if (previousCurrency === 'MYR' && newCurrency === 'USD') {
                // RM -> USD
                convertedValue = currentValue * rates.RM_TO_USD_RATE;
            } else if (previousCurrency === 'USD' && newCurrency === 'MYR') {
                // USD -> RM
                convertedValue = currentValue * rates.USD_TO_RM_RATE;
            }

            // Update the input field with the new value (rounded to 2 decimal places)
            fixedInput.value = convertedValue.toFixed(2);
            
            // Store the new currency as the "last" one for the next change event
            currencySelect.dataset.lastCurrency = newCurrency;
            
            // Recalculate all results
            calculate();
        }


        /**
         * @function toggleCalculationType
         * Hides/shows the relevant input group (Rate or Fixed Amount) based on radio button selection.
         */
        function toggleCalculationType() {
            const type = document.querySelector('input[name="profitType"]:checked').value;
            const percentageGroup = document.getElementById('percentageInputGroup');
            const fixedGroup = document.getElementById('fixedAmountInputGroup');
            
            if (type === 'percentage') {
                percentageGroup.classList.remove('hidden');
                fixedGroup.classList.add('hidden');
            } else { // type === 'fixed'
                percentageGroup.classList.add('hidden');
                fixedGroup.classList.remove('hidden');
            }
            calculate(); // Recalculate immediately
        }

        /**
         * @function updateExchangeRateDisplay
         * Updates the text showing the current exchange rate used and its source.
         */
        function updateExchangeRateDisplay() {
            const rates = getExchangeRates();
            const rmToUsd = rates.RM_TO_USD_RATE.toFixed(4); // Display 4 decimal places for precision
            document.getElementById('currentExchangeRateDisplay').textContent = translations[currentLang].currentRateFormat(rmToUsd);
        }

        /**
         * @function applyResultStyling
         * Toggles between profit (green) and loss (red) styling for result boxes AND the main card.
         * @param {boolean} isLoss - True if the profit is negative, false otherwise.
         */
        function applyResultStyling(isLoss) {
            // Tailwind classes for success (Green - Primary) and loss (Red) states
            const profitClasses = ['bg-primary/10', 'border-primary/20', 'text-primary'];
            const lossClasses = ['bg-red-100', 'border-red-300', 'text-loss']; // using custom 'loss' color

            // 1. Logic for Result Boxes
            const resultElements = [
                document.getElementById('primaryResultDisplay'),
                document.getElementById('totalAmountDisplay')
            ];
            const valueElements = [
                document.getElementById('annualProfitResult'),
                document.getElementById('totalAmountResult'),
                document.getElementById('resultLabel'), 
                document.getElementById('labelTotalAmount') 
            ];

            resultElements.forEach(el => {
                // Manage background, border, and custom glow class
                profitClasses.slice(0, 2).forEach(c => el.classList.toggle(c, !isLoss));
                lossClasses.slice(0, 2).forEach(c => el.classList.toggle(c, isLoss));
                
                // Manage custom glow class for hover
                el.classList.toggle('result-box-profit', !isLoss);
                el.classList.toggle('result-box-loss', isLoss);

                // Ensure border remains visible
                el.classList.add('border');
            });

            valueElements.forEach(el => {
                // Manage text color
                profitClasses.slice(2).forEach(c => el.classList.toggle(c, !isLoss));
                lossClasses.slice(2).forEach(c => el.classList.toggle(c, isLoss));
            });

            // 2. Logic for Main Card
            const mainCard = document.getElementById('annual-profit-calculator');
            
            // Manage Border Color (top border)
            mainCard.classList.toggle('border-primary', !isLoss);
            mainCard.classList.toggle('border-loss', isLoss); 

            // Manage Hover Glow
            mainCard.classList.toggle('card-profit-glow', !isLoss);
            mainCard.classList.toggle('card-loss-glow', isLoss);
            
            // Manage Title Color
            document.getElementById('cardTitle').classList.toggle('text-primary', !isLoss);
            document.getElementById('cardTitle').classList.toggle('text-loss', isLoss);
        }


        /**
         * @function calculate
         * Calculates profit and total amount, converting inputs to the base currency (RM) and
         * converting final results back to the principal currency for display.
         */
        function calculate() {
            const t = translations[currentLang];
            const type = document.querySelector('input[name="profitType"]:checked').value;
            
            // Update the display of the current rate
            updateExchangeRateDisplay();
            
            // Get currency selection for display
            const principalCurrencyCode = document.getElementById('principalCurrencySelect').value;
            
            // 1. Convert ALL inputs to the Base Currency (MYR/RM)
            
            // Principal
            const principalInput = parseFloat(document.getElementById('principal').value) || 0;
            const principalInputCurrency = document.getElementById('principalCurrencySelect').value;
            const principalRM = convertToBaseCurrency(principalInput, principalInputCurrency);

            // Calculation Period
            const totalWeeks = getCalculationPeriods();

            const annualProfitResult = document.getElementById('annualProfitResult');
            const totalAmountResult = document.getElementById('totalAmountResult');
            const resultLabel = document.getElementById('resultLabel');
            
            // Duration Text
            const durationValue = document.getElementById('durationValue').value;
            const durationUnitElement = document.getElementById('durationUnit').options[document.getElementById('durationUnit').selectedIndex];
            // Uses the translation key from the selected option (e.g., durationUnitDays)
            const durationUnitKey = 'durationUnit' + durationUnitElement.value.charAt(0).toUpperCase() + durationUnitElement.value.slice(1);
            const durationUnitText = t[durationUnitKey]; 

            let newLabel = `${t.resultLabelInitial} ${durationValue} ${durationUnitText}`;

            let profitRM = 0;
            let totalAmountRM = principalRM;

            if (type === 'percentage') {
                newLabel += t.resultLabelCompoundingSuffix;
                const ratePercent = parseFloat(document.getElementById('rate').value) || 0;
                const rateFrequency = document.getElementById('rateFrequency').value;
                
                let ratePerWeek = 0; 

                if (principalRM > 0) { // Only calculate if there is initial capital
                    const rateDecimal = ratePercent / 100;
                    
                    if (rateFrequency === 'day') {
                        // Rate per day: (1 + rateDecimal)^7 - 1
                        ratePerWeek = Math.pow(1 + rateDecimal, DAYS_PER_WEEK) - 1;
                    } else if (rateFrequency === 'week') {
                        // Rate per week: directly
                        ratePerWeek = rateDecimal;
                    } else if (rateFrequency === 'month') {
                        // Rate per month: (1 + rateDecimal)^(1/WEEKS_PER_MONTH) - 1
                        ratePerWeek = Math.pow(1 + rateDecimal, 1 / WEEKS_PER_MONTH) - 1;
                    }
                }
                
                if (principalRM > 0 && totalWeeks > 0) {
                    totalAmountRM = principalRM * Math.pow(1 + ratePerWeek, totalWeeks);
                    profitRM = totalAmountRM - principalRM;
                } else {
                    totalAmountRM = principalRM;
                    profitRM = 0;
                }

            } else { // type === 'fixed'
                newLabel += t.resultLabelFixedSuffix;
                
                // Fixed Amount Input (Convert to RM)
                const fixedAmountInput = parseFloat(document.getElementById('fixedAmount').value) || 0;
                const fixedInputCurrency = document.getElementById('fixedCurrencySelect').value;
                const fixedAmountRM = convertToBaseCurrency(fixedAmountInput, fixedInputCurrency);

                const fixedFrequency = document.getElementById('fixedFrequency').value;

                let weeklyFixedProfitRM = 0;

                if (fixedFrequency === 'day') {
                    weeklyFixedProfitRM = fixedAmountRM * DAYS_PER_WEEK;
                } else if (fixedFrequency === 'week') {
                    weeklyFixedProfitRM = fixedAmountRM;
                } else if (fixedFrequency === 'month') {
                    weeklyFixedProfitRM = fixedAmountRM / WEEKS_PER_MONTH; 
                }
                
                if (totalWeeks > 0) {
                    profitRM = weeklyFixedProfitRM * totalWeeks;
                    totalAmountRM = principalRM + profitRM;
                } else {
                    profitRM = 0;
                    totalAmountRM = principalRM;
                }
            }
            
            // 2. Convert Final Results from Base Currency (RM) to Display Currency
            const profitDisplay = convertFromBaseCurrency(profitRM, principalCurrencyCode);
            const totalAmountDisplay = convertFromBaseCurrency(totalAmountRM, principalCurrencyCode);
            
            // Check for loss to apply red styling
            const isLoss = profitDisplay < 0;
            applyResultStyling(isLoss);


            // 3. Update Result Displays
            resultLabel.textContent = newLabel;
            
            // Use the formatCurrency function with the selected principal currency
            annualProfitResult.textContent = formatCurrency(profitDisplay, principalCurrencyCode);
            totalAmountResult.textContent = formatCurrency(totalAmountDisplay, principalCurrencyCode);
        }

        // Start calculation and update UI when the page loads
        window.onload = () => {
            // Set initial calculation type
            toggleCalculationType();
            
            // Initialize the last currency state for the auto-conversion feature (Principal)
            document.getElementById('principalCurrencySelect').dataset.lastCurrency = document.getElementById('principalCurrencySelect').value;
            
            // Initialize the last currency state for the auto-conversion feature (Fixed Amount)
            document.getElementById('fixedCurrencySelect').dataset.lastCurrency = document.getElementById('fixedCurrencySelect').value;

            // Set initial language UI (MS default). The checkbox is unchecked, so currentLang='ms'.
            const langSwitch = document.getElementById('lang-switch');
            langSwitch.checked = false; 
            toggleLanguage(); // Call this to set the initial state colors and labels
            
            // Add event listener to detect manual rate changes
            document.getElementById('exchangeRateInput').addEventListener('input', () => {
                // Mark source as manual when user types, then run calculation
                rateSource = 'manual';
                calculate(); 
            });

            // Add listener to other inputs/selects that now call calculate()
            document.getElementById('principal').oninput = calculate;
            document.getElementById('rate').oninput = calculate;
            document.getElementById('fixedAmount').oninput = calculate;
            document.getElementById('durationValue').oninput = calculate;
            
            // The currency selection calls convertPrincipalValue()/convertFixedAmountValue() which calls calculate()
            // Frequency and Unit selects call calculate() directly via onchange attributes in HTML
            
            // Perform initial calculation
            calculate(); 
        };

    </script>
</body>
</html>
